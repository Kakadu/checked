# $URL: dd $
# $Revision: 19 $

# default build:
# - update timestamp
# - build default target
# - build bytecode and optimized native code
all-am: $(TARGET)

# default clean
clean-am:
	rm -fR $(CMA) $(CMXA) $(CMOPK) $(CMXPK) $(CMIPK) $(OPK) $(CMO) $(CMI) $(CLEAN_CMI) $(CMX) $(OBJ) $(LIB) META $(CLEAN_EXTRA)

# manual install
install-data-am: $(TARGET)
	$(mkinstalldirs) $(CAMLPXLIB); \
	for i in $(TARGET); do \
	    $(INSTALL_DATA) $$i $(CAMLPXLIB)/$$i; \
	done

# manual uninstall
uninstall-am:
	for i in $(TARGET); do \
	    rm -f $(CAMLPXLIB)/$$i; \
	done

# cleanup autogenerated scripts in maintainer-clean mode
maintainer-clean-generic:
	rm -rf $(top_srcdir)/autom4te.cache $(CLEAN_EXTRA)

# what is byte-code target
.PHONY: byte-code bc
byte-code: $(BYTE)

# how to build bytecode target
$(BYTE): $(CMO)
	$(OCAMLC) $(BFLAGS) -o $@ $(EXTRA_CMA) $(CMO)

# what is native-code target
.PHONY: native-code nc
native-code: $(NATIVE)

# how to build native code target
$(NATIVE): $(CMX)
	$(OCAMLOPT) $(OFLAGS) $(STATIC) -o $@ $(EXTRA_CMXA) $(CMX)

# shorter acronims
bc: byte-code
nc: native-code

# how to build library
$(CMA): $(CMO4CMA)
	$(OCAMLC) -a -o $@ $(CMO4CMA)

# how to build native optimized library
$(CMXA): $(CMX4CMXA)
	$(OCAMLOPT) -a -o $@ $(CMX4CMXA)

# how to build packed CMO
$(CMOPK): $(CMO)
	$(OCAMLC) -o $@ -pack $(if $(findstring rectypes,$(BFLAGS)),-rectypes,) $^

# how to build packed CMX
$(CMXPK): $(CMX)
	$(OCAMLOPT) -o $@ -pack  $(if $(findstring rectypes,$(OFLAGS)),-rectypes,) $^

# META description for package
META: $(top_srcdir)/VERSION
	@echo "Generating META description"; \
	revision=`grep "\\$$Revision:" $< | sed -e 's,^\\$$,,' -e 's, \\$$$$,,'`; \
	date=`LC_TIME=C date`; \
	echo "version = \"$$revision\"" > $@; \
	echo "description = \"$(DESCRIPTION)\"" >> $@; \
	echo "requires = \"\"" >> $@; \
	echo "archive(byte) = \"$(PACKAGE).cma\"" >> $@; \
	echo "archive(native) = \"$(PACKAGE).cmxa\"" >> $@

# save compiled revision into module
version.ml: $(top_srcdir)/VERSION
	@echo "Generating version.ml"; \
	revision=`grep "\\$$Revision:" $< | sed -e 's,^\\$$,,' -e 's, \\$$$$,,'`; \
	date=`LC_TIME=C date`; \
	echo "let version = \"$$revision\"" > $@; \
	echo "let date = \"$$date\"" >> $@

# resolve compiling dependencies
.depend: $(SOURCES)
	ocamldep $(PXFLAGS) $(SOURCES) $(MLI) > .depend

doc:	
	ocamldoc $(MODULE_INCLUDES) $(AM_DOCFLAGS) $(PXFLAGS) -d $(top_srcdir)/doc/html/$(PACKAGE) *.mli
